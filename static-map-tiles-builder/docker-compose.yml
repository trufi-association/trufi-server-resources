version: '3'
services:
  map_builder:
    image: map_builder
    build: .
    environment:
      - city=$city
      - bbox=$bbox
    volumes:
      - ../data/$city/static_maps/static-maps:/app/out
    depends_on:
      tileserver:
        condition: service_healthy

  tileserver:
    # should be equal to the name of the folder name this compose is in
    image: maptiler/tileserver-gl
    command: --port 8080 --config /config/config.json --verbose
    volumes:
      - ./data:/region # the name of the folder on the host needs to have the name 'data' and it should contain the files you want to persist between docker container builds. This makes it easier to add (updated) data generated with https://github.com/trufi-association/trufi-server-resources
      - ./config:/config
    ports:
      - 8080:8080
    healthcheck:
      test: timeout 10s bash -c ':> /dev/tcp/127.0.0.1/8080' || exit 1
      interval: 30s
      timeout: 15s
      retries: 3

      #tileserver:
      #image: klokantech/tileserver-gl
      #volumes:
      #- ../map-data-builder/data/$city:/data # TODO: need to make this work again
      #healthcheck:
      #test: ["CMD", "curl", "-f", "http://localhost/health"]
      #interval: 5s
      #timeout: 2s
      #retries: 20
